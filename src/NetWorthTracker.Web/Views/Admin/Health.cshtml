@model NetWorthTracker.Core.ViewModels.HealthDashboardViewModel
@inject NetWorthTracker.Core.Services.IUserTimeZoneService TimeZone
@{
    ViewData["Title"] = "System Health";

    var statusColor = Model.OverallStatus switch
    {
        "Healthy" => "var(--color-success)",
        "Degraded" => "var(--color-warning)",
        "Unhealthy" => "var(--color-danger)",
        _ => "var(--color-secondary)"
    };

    var statusBadgeClass = Model.OverallStatus switch
    {
        "Healthy" => "bg-success",
        "Degraded" => "bg-warning text-dark",
        "Unhealthy" => "bg-danger",
        _ => "bg-secondary"
    };

    var statusIcon = Model.OverallStatus switch
    {
        "Healthy" => "bi-check-circle-fill",
        "Degraded" => "bi-exclamation-triangle-fill",
        "Unhealthy" => "bi-x-circle-fill",
        _ => "bi-question-circle-fill"
    };
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-title mb-0" style="border-bottom: none;">System Health</h2>
    <div>
        <a asp-action="Index" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
        </a>
        <button class="btn btn-primary ms-2" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
    </div>
</div>

<!-- Overall Status Card -->
<div class="card mb-4" style="border-left: 4px solid @statusColor;">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="bi @statusIcon" style="font-size: 3rem; color: @statusColor;"></i>
            </div>
            <div class="col">
                <h3 class="mb-1" style="font-family: var(--font-serif);">
                    <span class="badge @statusBadgeClass">@Model.OverallStatus</span>
                </h3>
                <p class="text-muted mb-0">
                    Last checked: @TimeZone.ToUserTime(Model.CheckedAt).ToString("MMM d, yyyy 'at' h:mm:ss tt")
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Health Checks -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Health Checks</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 200px;">Check</th>
                        <th style="width: 120px;">Status</th>
                        <th>Description</th>
                        <th style="width: 100px;" class="text-end">Duration</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var check in Model.Checks.OrderBy(c => c.Status == "Healthy" ? 2 : c.Status == "Degraded" ? 1 : 0))
                    {
                        var checkStatusColor = check.Status switch
                        {
                            "Healthy" => "success",
                            "Degraded" => "warning",
                            "Unhealthy" => "danger",
                            _ => "secondary"
                        };
                        var checkIcon = check.Status switch
                        {
                            "Healthy" => "bi-check-circle-fill",
                            "Degraded" => "bi-exclamation-triangle-fill",
                            "Unhealthy" => "bi-x-circle-fill",
                            _ => "bi-question-circle"
                        };
                        <tr>
                            <td>
                                <strong>@FormatCheckName(check.Name)</strong>
                            </td>
                            <td>
                                <span class="badge bg-@checkStatusColor">
                                    <i class="bi @checkIcon me-1"></i> @check.Status
                                </span>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(check.Description))
                                {
                                    <span>@check.Description</span>
                                }
                                @if (!string.IsNullOrEmpty(check.Exception))
                                {
                                    <br />
                                    <small class="text-danger">
                                        <i class="bi bi-exclamation-circle me-1"></i>@check.Exception
                                    </small>
                                }
                                @if (check.Data.Any())
                                {
                                    <br />
                                    <small class="text-muted">
                                        @foreach (var kvp in check.Data)
                                        {
                                            <span class="me-2">@kvp.Key: @kvp.Value</span>
                                        }
                                    </small>
                                }
                            </td>
                            <td class="text-end">
                                <code>@check.Duration.TotalMilliseconds.ToString("F1") ms</code>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Links</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/health" target="_blank" class="btn btn-outline-primary">
                        <i class="bi bi-code-slash me-2"></i>Health Endpoint (JSON)
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">System Information</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Server Time (UTC)</dt>
                    <dd class="col-sm-7">@DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss")</dd>

                    <dt class="col-sm-5">Environment</dt>
                    <dd class="col-sm-7">@Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "Production"</dd>

                    <dt class="col-sm-5">Machine Name</dt>
                    <dd class="col-sm-7">@Environment.MachineName</dd>

                    <dt class="col-sm-5">.NET Version</dt>
                    <dd class="col-sm-7">@Environment.Version</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@functions {
    string FormatCheckName(string name)
    {
        // Convert "database" to "Database", "background-jobs" to "Background Jobs"
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(
            name.Replace("-", " ").Replace("_", " ")
        );
    }
}
