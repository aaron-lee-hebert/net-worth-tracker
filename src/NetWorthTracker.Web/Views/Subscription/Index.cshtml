@model NetWorthTracker.Core.Entities.Subscription
@inject NetWorthTracker.Core.Services.IUserTimeZoneService TimeZone
@{
    ViewData["Title"] = "Subscription";
    var stripeConfigured = ViewBag.StripeConfigured as bool? ?? false;
    var expired = Context.Request.Query["expired"].FirstOrDefault() == "true";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="page-title mb-1" style="border-bottom: none;">Subscription</h2>
        <p class="text-muted mb-0">Manage your subscription and billing</p>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (expired)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Subscription Required</strong> - Your trial has ended or subscription has expired. Please subscribe to continue adding and editing your financial data.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!stripeConfigured)
{
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Self-Hosted Mode</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge bg-success me-2">Full Access</span>
                        <span class="text-muted">All features are available</span>
                    </div>
                    <p class="text-muted">
                        You're running Net Worth Tracker in self-hosted mode. All features are available without a subscription.
                    </p>
                    <p class="text-muted mb-0">
                        If you'd like to support the project, consider
                        <a href="https://www.buymeacoffee.com/aaronleehebert" target="_blank" class="link-primary">buying me a coffee</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
}
else if (Model == null)
{
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body text-center py-5">
                    <p class="text-muted">Loading subscription information...</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="row">
        <!-- Current Status -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Current Status</h5>
                </div>
                <div class="card-body">
                    @switch (Model.Status)
                    {
                        case NetWorthTracker.Core.Entities.SubscriptionStatus.Trialing:
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-info me-2">Trial</span>
                                <span class="text-muted">@Model.TrialDaysRemaining days remaining</span>
                            </div>
                            <p class="text-muted mb-4">
                                You're currently on a free trial. Your trial ends on <strong>@TimeZone.FormatInUserTime(Model.TrialEndsAt, "MMMM d, yyyy")</strong>.
                                Subscribe now to ensure uninterrupted access to all features.
                            </p>
                            <form asp-action="Subscribe" method="post" class="d-inline">
                                <button type="submit" class="btn btn-primary">
                                    Subscribe Now - $30/year
                                </button>
                            </form>
                            break;

                        case NetWorthTracker.Core.Entities.SubscriptionStatus.Active:
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-success me-2">Active</span>
                                <span class="text-muted">Subscription active</span>
                            </div>
                            <p class="text-muted mb-4">
                                Your subscription is active and will renew on <strong>@TimeZone.FormatInUserTime(Model.CurrentPeriodEnd, "MMMM d, yyyy")</strong>.
                            </p>
                            <form asp-action="ManageSubscription" method="post" class="d-inline">
                                <button type="submit" class="btn btn-outline-primary">
                                    Manage Subscription
                                </button>
                            </form>
                            break;

                        case NetWorthTracker.Core.Entities.SubscriptionStatus.PastDue:
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-warning text-dark me-2">Past Due</span>
                                <span class="text-muted">Payment required</span>
                            </div>
                            <p class="text-muted mb-4">
                                Your last payment failed. Please update your payment method to continue your subscription.
                            </p>
                            <form asp-action="ManageSubscription" method="post" class="d-inline">
                                <button type="submit" class="btn btn-warning">
                                    Update Payment Method
                                </button>
                            </form>
                            break;

                        case NetWorthTracker.Core.Entities.SubscriptionStatus.Canceled:
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-secondary me-2">Canceled</span>
                                @if (Model.HasActiveAccess)
                                {
                                    <span class="text-muted">Access until @TimeZone.FormatInUserTime(Model.CurrentPeriodEnd, "MMMM d, yyyy")</span>
                                }
                                else
                                {
                                    <span class="text-muted">Subscription ended</span>
                                }
                            </div>
                            <p class="text-muted mb-4">
                                @if (Model.HasActiveAccess)
                                {
                                    <text>Your subscription has been canceled but you still have access until the end of your billing period.</text>
                                }
                                else
                                {
                                    <text>Your subscription has ended. Subscribe to regain full access.</text>
                                }
                            </p>
                            <form asp-action="Subscribe" method="post" class="d-inline">
                                <button type="submit" class="btn btn-primary">
                                    Resubscribe - $30/year
                                </button>
                            </form>
                            break;

                        case NetWorthTracker.Core.Entities.SubscriptionStatus.Expired:
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-danger me-2">Expired</span>
                                <span class="text-muted">Subscription ended</span>
                            </div>
                            <div class="alert alert-info">
                                <strong>Read-Only Mode</strong> - You can still view your data, but adding or editing is disabled until you subscribe.
                            </div>
                            <p class="text-muted mb-4">
                                Your subscription has expired. Subscribe to regain full access to all features.
                            </p>
                            <form asp-action="Subscribe" method="post" class="d-inline">
                                <button type="submit" class="btn btn-primary">
                                    Subscribe Now - $30/year
                                </button>
                            </form>
                            break;
                    }
                </div>
            </div>
        </div>

        <!-- Pricing Info -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">What's Included</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            Unlimited accounts
                        </li>
                        <li class="mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            Net worth tracking
                        </li>
                        <li class="mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            Financial forecasts
                        </li>
                        <li class="mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            Quarterly reports
                        </li>
                        <li class="mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            CSV exports
                        </li>
                        <li class="mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            Multi-factor authentication
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-success me-2" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                            No ads, no tracking
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
}
